name: Build Ubuntu22.04 Docker Image

# 触发条件：1. 推送到 main 分支自动触发；2. 手动触发（新增）
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # 新增此行，启用手动触发按钮

jobs:
  build:
    # 构建环境：Ubuntu 22.04（与目标镜像系统一致）
    runs-on: ubuntu-22.04

    steps:
      # 步骤1：拉取 GitHub 仓库最新代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：初始化 Docker Buildx 环境（优化构建流程）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录 Docker Hub（使用已配置的 Secrets）
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 步骤4：构建并推送 Ubuntu22.04 镜像到 Docker Hub
      - name: Build and push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文：仓库根目录（对应 Dockerfile 位置）
          push: true  # 构建成功后自动推送镜像
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:latest  # 最新版本标签
            ${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:${{ github.sha }}  # Commit ID 标签（版本追溯）
          # 首次构建可注释以下 2 行（避免缓存不存在导致失败），成功后再取消注释
          # cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:buildcache
          # cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:buildcache,mode=max

name: Build Ubuntu22.04 Docker Image

# 触发条件：推送到 main 分支时自动运行（代码更新即触发构建）
on:
  push:
    branches: [ "main" ]

jobs:
  build:
    # 构建环境：使用 Ubuntu 22.04（与目标镜像系统一致，构建更兼容）
    runs-on: ubuntu-22.04

    steps:
      # 步骤1：拉取当前 GitHub 仓库的所有代码（包括 Dockerfile、forge 目录等）
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：初始化 Docker Buildx（优化 Docker 构建流程，支持缓存和多平台）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录 Docker Hub（使用你配置的 Secrets，安全无明文暴露）
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}  # 自动读取 GitHub Secrets 中的 Docker Hub 用户名（sssethan）
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}  

      # 步骤4：构建 Ubuntu 22.04 镜像并推送到 Docker Hub
      - name: Build and push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文：仓库根目录（确保能找到 Dockerfile）
          push: true  # 启用推送功能（构建成功后自动推送到 Docker Hub）
          tags: |  # 镜像标签（Docker Hub 地址：sssethan/firstweb）
            ${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:latest  # 最新版本标签（方便直接拉取）
            ${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:${{ github.sha }}  # 基于 commit ID 标签（版本追溯）
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:buildcache  # 缓存构建依赖（加速下次构建）
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/firstweb:buildcache,mode=max
